<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TBFM Demo</title>
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" type="text/css" href="resource/tinderesque.css">
  <link rel="stylesheet" type="text/css" href="resource/tbfm.css">
</head>
<body>
  <header>
    <h1>TBFM</h1>
  </header>
  <section>
    <div class="cardcontainer list">
      <ul class="cardlist" id="list-of-cards">
        <li class="card current">
          <midi-player id= "melody-player curr-player" src="" sound-font></midi-player>
          <img src="images/melody_image4.png" alt="">
        </li> get
        <li class="card next">
          <midi-player id= "melody-player next-player" src="" sound-font></midi-player>
          <img src="images/melody_image4.png" alt="">
        </li>
      </ul>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <button id="left-btn" class="but-nope">X</button>
      <button id="rght-btn" class="but-yay">âœ”</button>
      <span id="counter"></span>
    </div>
    <ul class="cardlist" id="results">
    </ul>
  </section>

  <footer>
    <p>Integration of Tinderesque demo by Chris Heilmann</p>
  </footer>

<script src="resource/tinderesque.js"></script>
<script src="resource/tbfm.js"></script>

<script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.21.0/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.1.0"></script>

<script>
  leftBtn = document.getElementById("left-btn");
  rghtBtn = document.getElementById("rght-btn");
  currcard = document.getElementById("melody-player curr-player");
  nextcard = document.getElementById("melody-player next-player");

  const MAX_M_INDEX = 10;
  var melodyIndex = 1;
  var melodySourc = "localhost:8000/"
  // var melodySourc = "http://sozopol.soe.ucsc.edu:8000/"
  function melody_name (altindex = melodyIndex) {return melodySourc + "melody" + altindex + ".mid"}
  
  console.log ("currcard: " + currcard + " nextcard: " + nextcard);
  // console.log ("currcard: " + currcard.getElementsByTagName("midi-player") + " nextcard: " + nextcard);

  // Set the current card
  function set_curr() {
    currcard.src = melodySourc + "melody" + melodyIndex + ".mid";
    currcard = document.getElementById("melody-player curr-player");
  }

  // Set the next card
  function set_next() {
    nextcard.src = melodySourc + "melody" + (1 + melodyIndex) + ".mid";
    nextcard = document.getElementById("melody-player next-player");
  }
  
  // Add a card
  function add_card() {
    let cardlist = document.getElementById("list-of-cards");
    cardlist.innerHTML += `
    <li class="card next">
          <midi-player id= "melody-player next-player" src="${melody_name(melodyIndex+1)}" sound-font></midi-player>
          <img src="images/melody_image4.png" alt="">
    </li>`;
  }

  // Increments melody index
  function incrMelodyIndex() {
    melodyIndex ++;
    if (melodyIndex > MAX_M_INDEX) {
      melodyIndex = 1;
    }
  }

  // Decrements melody index. 
  function decrMelodyIndex() {
    melodyIndex --;
    if (melodyIndex < 1) {
      melodyIndex = MAX_M_INDEX;
    }
  }

  // Call the swipe API
  function POST_swipe (result) {
    var myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");

    var raw = JSON.stringify({
      "method": "POST"
    });

    var requestOptions = {
      method: 'POST',
      headers: myHeaders,
      body: raw,
      redirect: 'follow'
    };

    fetch((melodySourc)+"melody"+(melodyIndex)+".mid?swiped="+(result?"true":"false"), requestOptions)
      .then(response => response.text())
      .then(result => console.log(result))
      .catch(error => console.log('error', error));
  }


  // Trigger left swipe event
  leftBtn.addEventListener("click", function(){
      POST_swipe(false); 
      incrMelodyIndex();
      add_card();
      // set_curr();
      set_next();
  });

  // Trigger right swipe event
  rghtBtn.addEventListener("click", function(){
    POST_swipe(true);
    incrMelodyIndex();
    add_card();
    // set_curr();
    set_next();
  });
  set_curr();
  set_next();
</script>
</body>
</html>

